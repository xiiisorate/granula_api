// Floor Plan Service API
// Управление планировками: загрузка, хранение, распознавание

syntax = "proto3";

package floorplan.v1;

option go_package = "github.com/xiiisorate/granula_api/shared/gen/floorplan/v1;floorplanv1";

import "google/protobuf/timestamp.proto";

// FloorPlanService manages floor plan documents.
service FloorPlanService {
  // Upload a new floor plan
  rpc Upload(UploadRequest) returns (UploadResponse);
  
  // Get a floor plan by ID
  rpc Get(GetRequest) returns (GetResponse);
  
  // List floor plans in a workspace
  rpc List(ListRequest) returns (ListResponse);
  
  // Update floor plan metadata
  rpc Update(UpdateRequest) returns (UpdateResponse);
  
  // Delete a floor plan
  rpc Delete(DeleteRequest) returns (DeleteResponse);
  
  // Start AI recognition
  rpc StartRecognition(StartRecognitionRequest) returns (StartRecognitionResponse);
  
  // Get recognition status
  rpc GetRecognitionStatus(GetRecognitionStatusRequest) returns (GetRecognitionStatusResponse);
  
  // Get presigned download URL
  rpc GetDownloadURL(GetDownloadURLRequest) returns (GetDownloadURLResponse);
}

// Floor plan status
enum FloorPlanStatus {
  FLOOR_PLAN_STATUS_UNSPECIFIED = 0;
  FLOOR_PLAN_STATUS_UPLOADED = 1;
  FLOOR_PLAN_STATUS_PROCESSING = 2;
  FLOOR_PLAN_STATUS_RECOGNIZED = 3;
  FLOOR_PLAN_STATUS_CONFIRMED = 4;
  FLOOR_PLAN_STATUS_FAILED = 5;
}

// Floor plan entity
message FloorPlan {
  string id = 1;
  string workspace_id = 2;
  string owner_id = 3;
  string name = 4;
  string description = 5;
  FloorPlanStatus status = 6;
  optional string recognition_job_id = 7;
  optional string scene_id = 8;
  FileInfo file_info = 9;
  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp updated_at = 11;
}

// File information
message FileInfo {
  string id = 1;
  string original_name = 2;
  string mime_type = 3;
  int64 size = 4;
  int32 width = 5;
  int32 height = 6;
}

// Recognition options
message RecognitionOptions {
  bool detect_load_bearing = 1;
  bool detect_wet_zones = 2;
  bool detect_furniture = 3;
  float scale = 4;
  int32 orientation = 5;
  int32 detail_level = 6;
}

// Upload request
message UploadRequest {
  string workspace_id = 1;
  string owner_id = 2;
  string name = 3;
  string description = 4;
  string file_name = 5;
  string mime_type = 6;
  bytes file_data = 7;
}

// Upload response
message UploadResponse {
  bool success = 1;
  FloorPlan floor_plan = 2;
}

// Get request
message GetRequest {
  string id = 1;
}

// Get response
message GetResponse {
  FloorPlan floor_plan = 1;
}

// List request
message ListRequest {
  string workspace_id = 1;
  int32 limit = 2;
  int32 offset = 3;
}

// List response
message ListResponse {
  repeated FloorPlan floor_plans = 1;
  int32 total = 2;
}

// Update request
message UpdateRequest {
  string id = 1;
  string name = 2;
  string description = 3;
}

// Update response
message UpdateResponse {
  bool success = 1;
  FloorPlan floor_plan = 2;
}

// Delete request
message DeleteRequest {
  string id = 1;
}

// Delete response
message DeleteResponse {
  bool success = 1;
}

// Start recognition request
message StartRecognitionRequest {
  string floor_plan_id = 1;
  RecognitionOptions options = 2;
}

// Start recognition response
message StartRecognitionResponse {
  bool success = 1;
  string job_id = 2;
}

// Get recognition status request
message GetRecognitionStatusRequest {
  string job_id = 1;
}

// Get recognition status response
message GetRecognitionStatusResponse {
  string job_id = 1;
  string status = 2;
  int32 progress = 3;
  string error = 4;
  // Recognition model (when status = completed)
  RecognitionModel model = 5;
}

// Recognition model - результат распознавания планировки
message RecognitionModel {
  // 3D bounds of the apartment
  Bounds3D bounds = 1;
  // Total area in square meters
  double total_area = 2;
  // Recognition confidence (0-1)
  double confidence = 3;
  // Scene elements
  SceneElements elements = 4;
  // Recognition metadata
  RecognitionMeta recognition = 5;
  // Warnings
  repeated string warnings = 6;
  // Processing time in ms
  int64 processing_time_ms = 7;
}

// 3D bounds
message Bounds3D {
  double width = 1;
  double height = 2;
  double depth = 3;
}

// Scene elements container
message SceneElements {
  repeated Wall3D walls = 1;
  repeated Room3D rooms = 2;
  repeated Furniture furniture = 3;
  repeated Utility utilities = 4;
}

// 3D Wall
message Wall3D {
  string id = 1;
  string type = 2;
  string name = 3;
  Point3D start = 4;
  Point3D end = 5;
  double height = 6;
  double thickness = 7;
  WallProperties properties = 8;
  repeated Opening3D openings = 9;
  ElementMetadata metadata = 10;
}

// 3D Point
message Point3D {
  double x = 1;
  double y = 2;
  double z = 3;
}

// 2D Point  
message Point2D {
  double x = 1;
  double y = 2;
}

// Wall properties
message WallProperties {
  bool is_load_bearing = 1;
  string material = 2;
  bool can_demolish = 3;
  string structural_type = 4;
}

// Opening in wall (door/window)
message Opening3D {
  string id = 1;
  string type = 2;
  string subtype = 3;
  double position = 4;
  double width = 5;
  double height = 6;
  double elevation = 7;
  string opens_to = 8;
  bool has_door = 9;
  repeated string connects_rooms = 10;
}

// 3D Room
message Room3D {
  string id = 1;
  string type = 2;
  string name = 3;
  string room_type = 4;
  repeated Point2D polygon = 5;
  double area = 6;
  double perimeter = 7;
  RoomProperties properties = 8;
  repeated string wall_ids = 9;
  RoomMetadata room_metadata = 10;
}

// Room properties
message RoomProperties {
  bool has_wet_zone = 1;
  bool has_ventilation = 2;
  bool has_window = 3;
  double min_allowed_area = 4;
  double ceiling_height = 5;
}

// Room metadata
message RoomMetadata {
  double confidence = 1;
  string label_on_plan = 2;
  double area_on_plan = 3;
}

// Furniture
message Furniture {
  string id = 1;
  string type = 2;
  string name = 3;
  string furniture_type = 4;
  Point3D position = 5;
  Rotation3D rotation = 6;
  Dimensions3D dimensions = 7;
  string room_id = 8;
  FurnitureProperties properties = 9;
}

// 3D Rotation
message Rotation3D {
  double x = 1;
  double y = 2;
  double z = 3;
}

// 3D Dimensions
message Dimensions3D {
  double width = 1;
  double height = 2;
  double depth = 3;
}

// Furniture properties
message FurnitureProperties {
  bool can_relocate = 1;
  string category = 2;
  bool requires_water = 3;
  bool requires_gas = 4;
  bool requires_drain = 5;
}

// Utility (risers, vents)
message Utility {
  string id = 1;
  string type = 2;
  string name = 3;
  string utility_type = 4;
  Point3D position = 5;
  UtilityDimensions dimensions = 6;
  string room_id = 7;
  UtilityProperties properties = 8;
}

// Utility dimensions
message UtilityDimensions {
  double diameter = 1;
  double width = 2;
  double depth = 3;
}

// Utility properties
message UtilityProperties {
  bool can_relocate = 1;
  double protection_zone = 2;
  bool shared_with_neighbors = 3;
}

// Element metadata
message ElementMetadata {
  double confidence = 1;
  string source = 2;
  bool locked = 3;
  bool visible = 4;
  string model_url = 5;
}

// Recognition metadata
message RecognitionMeta {
  string source_type = 1;
  string quality = 2;
  string scale = 3;
  int32 orientation = 4;
  bool has_dimensions = 5;
  bool has_annotations = 6;
  string building_type = 7;
}

// Get download URL request
message GetDownloadURLRequest {
  string floor_plan_id = 1;
}

// Get download URL response
message GetDownloadURLResponse {
  string url = 1;
  int32 expires_in = 2; // seconds
}

