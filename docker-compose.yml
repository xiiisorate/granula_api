# =============================================================================
# Granula API - Docker Compose Configuration
# =============================================================================
# Development environment for local testing and development.
# All services are configured with health checks and proper networking.
#
# Usage:
#   docker-compose up -d              # Start all services
#   docker-compose up -d api-gateway  # Start only API Gateway and dependencies
#   docker-compose logs -f            # View logs
#   docker-compose down               # Stop all services
#   docker-compose down -v            # Stop and remove volumes
#
# =============================================================================

version: '3.8'

# =============================================================================
# Networks
# =============================================================================
networks:
  granula-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_auth_data:
  postgres_user_data:
  postgres_workspace_data:
  postgres_request_data:
  postgres_floorplan_data:
  postgres_compliance_data:
  mongo_data:
  redis_data:
  minio_data:

# =============================================================================
# Services
# =============================================================================
services:
  # ===========================================================================
  # Infrastructure Services
  # ===========================================================================

  # PostgreSQL for Auth Service
  postgres-auth:
    image: postgres:16-alpine
    container_name: granula-postgres-auth
    environment:
      POSTGRES_USER: granula
      POSTGRES_PASSWORD: granula_secret
      POSTGRES_DB: auth_db
    volumes:
      - postgres_auth_data:/var/lib/postgresql/data
    networks:
      - granula-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U granula -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # PostgreSQL for User Service
  postgres-user:
    image: postgres:16-alpine
    container_name: granula-postgres-user
    environment:
      POSTGRES_USER: granula
      POSTGRES_PASSWORD: granula_secret
      POSTGRES_DB: users_db
    volumes:
      - postgres_user_data:/var/lib/postgresql/data
    networks:
      - granula-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U granula -d users_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # PostgreSQL for Workspace Service
  postgres-workspace:
    image: postgres:16-alpine
    container_name: granula-postgres-workspace
    environment:
      POSTGRES_USER: granula
      POSTGRES_PASSWORD: granula_secret
      POSTGRES_DB: workspaces_db
    volumes:
      - postgres_workspace_data:/var/lib/postgresql/data
    networks:
      - granula-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U granula -d workspaces_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # PostgreSQL for Request Service
  postgres-request:
    image: postgres:16-alpine
    container_name: granula-postgres-request
    environment:
      POSTGRES_USER: granula
      POSTGRES_PASSWORD: granula_secret
      POSTGRES_DB: requests_db
    volumes:
      - postgres_request_data:/var/lib/postgresql/data
    networks:
      - granula-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U granula -d requests_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # PostgreSQL for Floor Plan Service
  postgres-floorplan:
    image: postgres:16-alpine
    container_name: granula-postgres-floorplan
    environment:
      POSTGRES_USER: granula
      POSTGRES_PASSWORD: granula_secret
      POSTGRES_DB: floorplans_db
    volumes:
      - postgres_floorplan_data:/var/lib/postgresql/data
    networks:
      - granula-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U granula -d floorplans_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # PostgreSQL for Compliance Service
  postgres-compliance:
    image: postgres:16-alpine
    container_name: granula-postgres-compliance
    environment:
      POSTGRES_USER: granula
      POSTGRES_PASSWORD: granula_secret
      POSTGRES_DB: compliance_db
    volumes:
      - postgres_compliance_data:/var/lib/postgresql/data
    networks:
      - granula-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U granula -d compliance_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # MongoDB for Scene, Branch, AI Services
  mongodb:
    image: mongo:7.0
    container_name: granula-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: granula
      MONGO_INITDB_ROOT_PASSWORD: granula_secret
    volumes:
      - mongo_data:/data/db
    networks:
      - granula-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis for caching and pub/sub
  redis:
    image: redis:7-alpine
    container_name: granula-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - granula-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # MinIO for object storage
  minio:
    image: minio/minio:latest
    container_name: granula-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: granula_admin
      MINIO_ROOT_PASSWORD: granula_secret_key
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Console
    networks:
      - granula-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ===========================================================================
  # Application Services
  # ===========================================================================

  # API Gateway (HTTP -> gRPC)
  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    container_name: granula-api-gateway
    environment:
      APP_ENV: development
      LOG_LEVEL: debug
      HTTP_PORT: 8080
      REDIS_URL: redis://redis:6379
      AUTH_SERVICE_ADDR: auth-service:50051
      USER_SERVICE_ADDR: user-service:50052
      WORKSPACE_SERVICE_ADDR: workspace-service:50053
      FLOOR_PLAN_SERVICE_ADDR: floorplan-service:50054
      SCENE_SERVICE_ADDR: scene-service:50055
      BRANCH_SERVICE_ADDR: branch-service:50056
      AI_SERVICE_ADDR: ai-service:50057
      COMPLIANCE_SERVICE_ADDR: compliance-service:50058
      REQUEST_SERVICE_ADDR: request-service:50059
      NOTIFICATION_SERVICE_ADDR: notification-service:50060
      JWT_SECRET: dev-secret-change-in-production
      SWAGGER_ENABLED: "true"
    ports:
      - "8080:8080"
    networks:
      - granula-network
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Auth Service
  auth-service:
    build:
      context: .
      dockerfile: auth-service/Dockerfile
    container_name: granula-auth-service
    environment:
      APP_ENV: development
      GRPC_PORT: 50051
      DB_HOST: postgres-auth
      DB_PORT: 5432
      DB_USER: granula
      DB_PASSWORD: granula_secret
      DB_NAME: auth_db
      DB_SSLMODE: disable
      REDIS_URL: redis://redis:6379
      JWT_SECRET: dev-secret-change-in-production
    networks:
      - granula-network
    depends_on:
      postgres-auth:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # User Service
  user-service:
    build:
      context: .
      dockerfile: user-service/Dockerfile
    container_name: granula-user-service
    environment:
      APP_ENV: development
      GRPC_PORT: 50052
      DB_HOST: postgres-user
      DB_PORT: 5432
      DB_USER: granula
      DB_PASSWORD: granula_secret
      DB_NAME: users_db
      DB_SSLMODE: disable
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: granula_admin
      MINIO_SECRET_KEY: granula_secret_key
    networks:
      - granula-network
    depends_on:
      postgres-user:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped

  # Workspace Service
  workspace-service:
    build:
      context: .
      dockerfile: workspace-service/Dockerfile
    container_name: granula-workspace-service
    environment:
      APP_ENV: development
      GRPC_PORT: 50053
      POSTGRES_DSN: postgres://granula:granula_secret@postgres-workspace:5432/workspaces_db?sslmode=disable
      REDIS_URL: redis://redis:6379
    networks:
      - granula-network
    depends_on:
      postgres-workspace:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Floor Plan Service
  floorplan-service:
    build:
      context: .
      dockerfile: floorplan-service/Dockerfile
    container_name: granula-floorplan-service
    environment:
      APP_ENV: development
      GRPC_PORT: 50054
      POSTGRES_DSN: postgres://granula:granula_secret@postgres-floorplan:5432/floorplans_db?sslmode=disable
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: granula_admin
      MINIO_SECRET_KEY: granula_secret_key
      AI_SERVICE_ADDR: ai-service:50057
      SCENE_SERVICE_ADDR: scene-service:50055
    networks:
      - granula-network
    depends_on:
      postgres-floorplan:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped

  # Scene Service
  scene-service:
    build:
      context: .
      dockerfile: scene-service/Dockerfile
    container_name: granula-scene-service
    environment:
      APP_ENV: development
      GRPC_PORT: 50055
      MONGODB_URI: mongodb://granula:granula_secret@mongodb:27017/scenes_db?authSource=admin
      COMPLIANCE_SERVICE_ADDR: compliance-service:50058
    networks:
      - granula-network
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped

  # Branch Service
  branch-service:
    build:
      context: .
      dockerfile: branch-service/Dockerfile
    container_name: granula-branch-service
    environment:
      APP_ENV: development
      GRPC_PORT: 50056
      MONGODB_URI: mongodb://granula:granula_secret@mongodb:27017/branches_db?authSource=admin
      SCENE_SERVICE_ADDR: scene-service:50055
    networks:
      - granula-network
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped

  # AI Service
  ai-service:
    build:
      context: .
      dockerfile: ai-service/Dockerfile
    container_name: granula-ai-service
    environment:
      APP_ENV: development
      GRPC_PORT: 50057
      MONGODB_URI: mongodb://granula:granula_secret@mongodb:27017/ai_db?authSource=admin
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      OPENROUTER_MODEL: openai/gpt-4o
    networks:
      - granula-network
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped

  # Compliance Service
  compliance-service:
    build:
      context: .
      dockerfile: compliance-service/Dockerfile
    container_name: granula-compliance-service
    environment:
      APP_ENV: development
      GRPC_PORT: 50058
      POSTGRES_DSN: postgres://granula:granula_secret@postgres-compliance:5432/compliance_db?sslmode=disable
    networks:
      - granula-network
    depends_on:
      postgres-compliance:
        condition: service_healthy
    restart: unless-stopped

  # Request Service
  request-service:
    build:
      context: .
      dockerfile: request-service/Dockerfile
    container_name: granula-request-service
    environment:
      APP_ENV: development
      GRPC_PORT: 50059
      POSTGRES_DSN: postgres://granula:granula_secret@postgres-request:5432/requests_db?sslmode=disable
      NOTIFICATION_SERVICE_ADDR: notification-service:50060
    networks:
      - granula-network
    depends_on:
      postgres-request:
        condition: service_healthy
    restart: unless-stopped

  # Notification Service
  notification-service:
    build:
      context: .
      dockerfile: notification-service/Dockerfile
    container_name: granula-notification-service
    environment:
      APP_ENV: development
      GRPC_PORT: 50060
      DB_HOST: postgres-auth
      DB_PORT: 5432
      DB_USER: granula
      DB_PASSWORD: granula_secret
      DB_NAME: auth_db
      DB_SSLMODE: disable
      REDIS_URL: redis://redis:6379
    networks:
      - granula-network
    depends_on:
      postgres-auth:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
